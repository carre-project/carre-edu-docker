"use strict";var angular=angular;angular.module("edumaterialApp",["ngCookies","ngSanitize","ngAnimate","ui.router","ui.bootstrap","angular-loading-bar","uuid4","ui.gravatar","ngOnload"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider","$compileProvider",function($stateProvider,$urlRouterProvider,$locationProvider,$httpProvider,$compileProvider){$urlRouterProvider.otherwise("/"),$locationProvider.html5Mode(!0),$compileProvider.debugInfoEnabled(!1)}]).config(["cfpLoadingBarProvider",function(cfpLoadingBarProvider){cfpLoadingBarProvider.latencyThreshold=300}]).config(["gravatarServiceProvider",function(gravatarServiceProvider){gravatarServiceProvider.defaults={size:100,"default":"mm"},gravatarServiceProvider.secure=!0}]).config(["$provide",function($provide){$provide.decorator("$state",["$delegate","$stateParams",function($delegate,$stateParams){return $delegate.forceReload=function(){return $delegate.go($delegate.current,$stateParams,{reload:!0,inherit:!1,notify:!0})},$delegate}])}]).run(["$rootScope","$location","Auth","$cookies","$window","$http",function($rootScope,$location,Auth,$cookies,$window,$http){var availableLangs=["el","en","lt"],passedLanguage=$location.search().lang;passedLanguage&&availableLangs.indexOf(passedLanguage)>=0?Auth.language=passedLanguage:Auth.language=$cookies.get("CARRE_LANG")||window.CARRE_EDU_CONFIGURATION.language.substring(0,2)||"en",$location.search().embed&&($rootScope.isEmbedded=!0)}]).constant("CONFIG",{currentUser:{},language:window.CARRE_EDU_CONFIGURATION.language.substring(0,2),api_url:window.CARRE_EDU_CONFIGURATION.api_url,token_name:window.CARRE_EDU_CONFIGURATION.token_name,auth_url:window.CARRE_EDU_CONFIGURATION.auth_url,graph_url:window.CARRE_EDU_CONFIGURATION.graph_url,subgraph_url:window.CARRE_EDU_CONFIGURATION.subgraph_url}),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(function(registration){console.log("ServiceWorker registration successful with scope: ",registration.scope)})["catch"](function(err){console.log("ServiceWorker registration failed: ",err)}),angular.module("edumaterialApp").service("article",["rdf","uuid4","rank","Auth","CONFIG",function(rdf,uuid4,rank,Auth,CONFIG){function getUserRatedArticles(){rdf.find([["?s",rdf.pre.edu+"#url","?url"],["?rating",rdf.pre.edu+"#for_article","?s"],["?rating",rdf.pre.edu+"#rated_by_user",user.graphName]],["?url ?rating"],["LIMIT 1000"]).then(function(results){userRatedArticles=results.data,console.log(userRatedArticles)})}function getRatedArticles(articles){console.log("Rated articles fetching");for(var exQuery="SELECT ?url (AVG(?ratingval) as ?ratingavg) FROM <http://"+CONFIG.graph_url+"/"+CONFIG.subgraph_url+"> WHERE {",i=0;i<articles.length;i++)articles[i].url=articles[i].url||"http://"+Auth.language+".wikipedia.org/wiki/"+encodeURIComponent(articles[i].title).split("%20").join("_"),exQuery+="{ ?s <"+rdf.pre.edu+"#url> <"+articles[i].url+"> }",i<articles.length-1&&(exQuery+=" UNION ");return exQuery+=" .?s <"+rdf.pre.edu+"#url> ?url . ?rating <"+rdf.pre.rdftype+"> <"+rdf.pre.edu+"#rating> . ?rating <"+rdf.pre.edu+"#for_article> ?s . ?rating ?any ?ratingval . FILTER (datatype(?ratingval) = xsd:nonNegativeInteger) } GROUP BY ?url LIMIT 20",rdf.query(exQuery).then(function(data){return console.log("Rated Articles are:"),ratedArticles=data.data,console.log(ratedArticles),ratedArticles})["catch"](function(err){console.log(err)})}function getEducationalObject(id){console.log("fecth object by id");var eduid="http://"+CONFIG.graph_url+"/"+CONFIG.subgraph_url+"/educational/"+id;return rdf.find([[eduid,rdf.pre.edu+"#url","?url"],[eduid,rdf.pre.edu+"#title","?title"],[eduid,rdf.pre.edu+"#snippet","?snippet"]],["?url ?title ?snippet"],["LIMIT 100"])}function processArticle(article){return article.riskElement=article.riskElement,curArticle=article,rdf.find([["?id",rdf.pre.edu+"#url",article.url],["?id",rdf.pre.edu+"#views","?views"]],["?id ?views"],["LIMIT 1"]).then(function(results){var elem={};results.data.data.length>0?(elem=results.data.data[0],console.log("Article exists: ",elem.id),article.id=elem.id.value.split(CONFIG.graph_url+"/"+CONFIG.subgraph_url+"/educational/")[1],article.views=Number(elem.views.value),modifyArticleViews({id:article.id,views:article.views,url:article.url,riskElement:article.riskElement})):(console.log("Article NOT exists: ",results.data.data),article.id=uuid4.generate(),article.views=1,insertArticle(article)),curArticle.id=article.id})["catch"](function(err){return console.log(err),!1})}function modifyArticleViews(article){var oldtriples=[],newtriples=[];oldtriples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#views",'"'+article.views+'"^^xsd:nonNegativeInteger']),newtriples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#views",'"'+(article.views+1)+'"^^xsd:nonNegativeInteger']),rdf.modify(oldtriples,oldtriples,newtriples).then(function(results){console.log(newtriples),console.log(results)})["catch"](function(error){console.log("Error :"),console.log(error)})}function insertArticle(article){var triples=[];triples.push([rdf.pre.publicUri+article.id,rdf.pre.rdftype,rdf.pre.edu+"#object"]),triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#url",article.url]),triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#views",'"'+article.views+'"^^xsd:nonNegativeInteger']),article.date&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#date_accepted",'"'+article.date+'"^^xsd:dateTime']),article.title&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#title",'"'+encodeURIComponent(article.title)+'"^^xsd:string']),article.snippet&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#snippet",'"'+encodeURIComponent(article.snippet)+'"^^xsd:string']),article.lang&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#language",'"'+article.lang+'"^^xsd:string']),article.wordcount&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#wordcount",'"'+article.wordcount+'"^^xsd:nonNegativeInteger']),article.categories&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#categories",'"'+article.categories+'"^^xsd:string']),article.source&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#source",'"'+article.source+'"^^xsd:string']),article.websource&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#websource",'"'+article.websource+'"^^xsd:string']),article.altTitle&&triples.push([rdf.pre.publicUri+article.id,rdf.pre.edu+"#alternative_title",'"'+article.altTitle+'"^^xsd:string']),rdf.insert(triples).then(function(results){console.log(triples),console.log(results)})["catch"](function(error){console.log("Error :"),console.log(error)})}var ratedArticles=[],userRatedArticles=[],curArticle={},user={};return Auth.token?Auth.getCurrentUser().$promise?Auth.getCurrentUser().then(function(){user=Auth.getCurrentUser()}):user=Auth.getCurrentUser():user={},user.hasOwnProperty("username")||(user.graphName=rdf.pre.users+"guestuser"),{getById:getEducationalObject,getUserRated:getUserRatedArticles,getRated:getRatedArticles,userRated:function(){return userRatedArticles},rated:function(){return ratedArticles},insert:processArticle,getCurrent:function(){return curArticle}}}]),String.prototype.distance=function(c){var a;a=this;var h,b,d,k,e,g,f,l,n,m,p;for(a.length>c.length&&(c=[c,a],a=c[0],c=c[1]),k=~~Math.max(0,c.length/2-1),e=[],g=[],b=n=0,p=a.length;n<p;b=++n)for(h=a[b],l=Math.max(0,b-k),f=Math.min(b+k+1,c.length),d=m=l;l<=f?m<f:m>f;d=l<=f?++m:--m)if(null==g[d]&&h===c[d]){e[b]=h,g[d]=c[d];break}if(e=e.join(""),g=g.join(""),d=e.length){for(b=f=k=0,l=e.length;f<l;b=++f)h=e[b],h!==g[b]&&k++;for(b=g=e=0,f=a.length;g<f&&(h=a[b],h===c[b]);b=++g)e++;a=(d/a.length+d/c.length+(d-~~(k/2))/d)/3,a+=.1*Math.min(e,4)*(1-a)}else a=0;return a},angular.module("edumaterialApp").service("jaroWinkler",function(){return!0}),angular.module("edumaterialApp").controller("MainCtrl",["CONFIG","$scope","$http","Auth","$location","$state","suggest","$sce","main","$timeout","medlineplus","$window","article","rating",function(CONFIG,$scope,$http,Auth,$location,$state,suggest,$sce,main,$timeout,medlineplus,$window,article,rating){function init(){$scope.total=0,$scope.results=[],$state.params.searchquery&&($scope.queryTerm=$state.params.searchquery,$timeout(function(){$scope.searchQuery()},50)),$state.params.eduid&&article.getById($state.params.eduid).then(function(res){console.debug(res),$scope.results=[{title:res.data.data[0].title.value,url:res.data.data[0].url.value,snippet:res.data.data[0].snippet.value}],calculateRatedArticles(!0)}),Auth.searchQuery&&($scope.queryTerm=Auth.searchQuery,$scope.searchQuery())}function plainText(text){return String(text).replace(/<[^>]+>/gm,"")}$scope.isLoggedIn=Auth.isLoggedIn;var user={};Auth.token?Auth.getCurrentUser().$promise?Auth.getCurrentUser().then(function(){user=Auth.getCurrentUser()}):user=Auth.getCurrentUser():user={},$scope.user=user,$scope.beta=!1,$scope.nextElement=function(){$scope.betaCurrentElement=$scope.betaCurrentElement||1,$scope.betaCurrentElement++,console.log($scope.betaCurrentElement),$scope.onComplete($scope.riskElements[$scope.betaCurrentElement],$scope.riskElements)},$scope.riskElements=[],suggest.riskelements().then(function(data){$scope.riskElements=data,console.log($scope.riskElements),$scope.beta&&$scope.nextElement()}),$scope.docSources=[{label:"Wikipedia",value:"wikipedia"}],$scope.curSource=$scope.docSources[0],"en"===Auth.language&&$scope.docSources.push({label:"MedlinePLUS",value:"medlineplus"}),$scope.itemsPerPage=10,$scope.currentPage=1,$scope.rating=[{rdftype:"depth_of_coverage",name:"Depth of Coverage",value:0},{rdftype:"comprehensiveness",name:"Comprehensiveness",value:0},{rdftype:"relevancy",name:"Relevancy",value:0},{rdftype:"accuracy",name:"Accuracy",value:0},{rdftype:"educational_level",name:"Educational level",value:0},{rdftype:"validity",name:"Validity",value:0}],Auth.rating_criteria=$scope.rating,$scope.getSuggestions=function(val){return suggest["for"](val)},$scope.onComplete=function(item,model,label){$scope.beta&&($scope.queryTerm=item.name,console.log("OnComplete:",item,model)),item&&($scope.riskElement=item),$scope.searchQuery()},$scope.toggleArticle=function(i){i>-1?($scope.showArticle=!0,$scope.frameHeight=$window.innerHeight-50,$scope.mobile=!0,$scope.doc=$scope.results[i],$scope.doc.pos=i,$scope.doc.rating=$scope.doc.rating||[],$scope.doc.iframe="",$scope.doc.riskElement=$scope.riskElement?$scope.riskElement.url:"",$timeout(function(){$scope.doc.iframe=renderContent(),document.querySelector("body").style.overflowY=$scope.showArticle?"hidden":"visible"},900)):($scope.isLoggedIn()&&main.setRating($scope.doc.rating).then(function(ratingId){calculateRatedArticles()}),$scope.isCollapsed=!1,$scope.doc={},$scope.doc.iframe="",$scope.showArticle=!1,$timeout(function(){document.querySelector("body").style.overflowY=$scope.showArticle?"hidden":"visible"},100))};var processData=function(){main.setArticle({title:plainText($scope.doc.title),snippet:plainText($scope.doc.FullSummary||$scope.doc.snippet),date:(new Date).toISOString(),url:$scope.doc.url,websource:$scope.curSource.value,source:plainText($scope.doc.organizationName||""),mesh:plainText($scope.doc.mesh||""),lang:Auth.language,altTitle:plainText($scope.doc.altTitle||""),categories:plainText($scope.doc.groupName||""),wordcount:$scope.doc.wordcount||"",riskElement:$scope.doc.riskElement}),console.log($scope.doc.riskElement),main.setRank({position:$scope.doc.pos,total:$scope.total,date:(new Date).toISOString(),query:encodeURIComponent($scope.queryTerm),article_risk:$scope.doc.riskElement}),$scope.isLoggedIn()&&rating.load({url:$scope.doc.url}).then(function(res){var rating=res.data.data[0];console.log("Rating Object is "),console.log(rating),$scope.doc.rating=[];for(var i=0;i<6;i++)$scope.doc.rating[i]={value:0};rating&&($scope.doc.rating[0].value=rating.depth_of_coverage.value||0,$scope.doc.rating[1].value=rating.comprehensiveness.value||0,$scope.doc.rating[2].value=rating.relevancy.value||0,$scope.doc.rating[3].value=rating.accuracy.value||0,$scope.doc.rating[4].value=rating.educational_level.value||0,$scope.doc.rating[5].value=rating.validity.value||0)}),main.editArticle()},renderContent=function(){var data="";switch($scope.doc.title=plainText($scope.doc.title),$scope.curSource.value){case"medlineplus":data=$scope.mobile?'<div style="background:#ffffff;height:'+$scope.frameHeight+'px; overflow-y:auto;"><h2>'+$scope.doc.title+"</h2><p>"+$scope.doc.FullSummary+"</p></div>":'<base target="_blank" /><iframe style="width:100%;height:'+$scope.frameHeight+'px;" class="embed-responsive-item" src="'+$scope.doc.url.replace("http://","https://")+'"sandbox="allow-same-origin"></iframe>';break;case"wikipedia":$scope.doc.iframeurl="/api/wikipedia/proxy/"+Auth.language+"/"+encodeURIComponent($scope.doc.title).split("%20").join("_"),data='<base target="_blank" /><iframe style="width:100%;height:'+$scope.frameHeight+'px;" class="embed-responsive-item" src="'+$scope.doc.iframeurl+'"></iframe>'}return processData(),$sce.trustAsHtml(data)};$scope.searchQuery=function(){if(void 0!=$scope.queryTerm&&""!==$scope.queryTerm)switch(Auth.searchQuery=$scope.queryTerm,Auth.notifyNavbar(),$scope.curSource.value){case"medlineplus":searchMedlinePlus();break;case"wikipedia":searchWikiPedia();break;default:console.log("no source selected")}};var searchMedlinePlus=function(){medlineplus.search(($scope.currentPage-1)*$scope.itemsPerPage,$scope.queryTerm,$scope.itemsPerPage).then(function(response){console.log("---medlineplus Results---",response),response.data.message?($scope.total=0,$scope.results=[]):($scope.results=response.data.list,$scope.total=Number(response.data.count[0]),$scope.pageCount=Math.ceil($scope.total/$scope.itemsPerPage),$scope.total>$scope.itemsPerPage&&$scope.results.retstart&&($scope.currentPage=Math.ceil($scope.results.retstart[0]/$scope.itemsPerPage)+1),calculateRatedArticles())})},searchWikiPedia=function(){$http.get("/api/wikipedia/search/"+encodeURIComponent($scope.queryTerm)+"/"+$scope.itemsPerPage+"/"+($scope.currentPage-1)*$scope.itemsPerPage+"/"+Auth.language,{cache:!0}).then(function(response){console.log("---Wikipedia Results---",response),response.data.search.length>0?($scope.results=response.data.search,$scope.total=response.data.searchinfo.totalhits,$scope.pageCount=Math.ceil($scope.total/$scope.itemsPerPage),$scope.suggestion=response.data.searchinfo.suggestion,calculateRatedArticles()):($scope.total=0,$scope.results=[])})};init();var calculateRatedArticles=function(single){article.getRated($scope.results).then(function(data){for(var i=0,l=data.data;i<l.length;i++)for(var j=0;j<$scope.results.length;j++)$scope.results[j].url===l[i].url.value&&($scope.results[j].avgRating=l[i].ratingavg.value);single&&$timeout(function(){$scope.toggleArticle(0)},100),$scope.beta&&$scope.start()})};$scope.start=function(){var left=$scope.results.length>20?20:$scope.results.length,ticker=function(){console.log("At "+left),$scope.toggleArticle(left-1),$timeout(function(){$scope.toggleArticle(-1)},4e3),left-=1,left>=0?($timeout(ticker,5e3),console.log("At :",left)):$scope.beta&&left===-1&&$scope.nextElement()};ticker()}}]),angular.module("edumaterialApp").config(["$stateProvider",function($stateProvider){$stateProvider.state("main",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl"}).state("search",{url:"/search/:searchquery?",templateUrl:"app/main/main.html",controller:"MainCtrl"}).state("article",{url:"/article/:eduid?",templateUrl:"app/main/main.html",controller:"MainCtrl"})}]),angular.module("edumaterialApp").service("main",["$q","article","rdf","rank","rating","CONFIG",function($q,article,rdf,rank,rating,CONFIG){function editArticle(){console.log("editArticle called!"),$q.all([article.insert(curArticle).then(function(){return curArticle.id=article.getCurrent().id,curRank.article_id=curArticle.id,curRank.article_risk=article.getCurrent().riskElement,rank.insert(curRank)},function(err){console.log(err)})]).then(function(responses){console.log("Responses : ",responses)})}function fetchArticles(){console.log("fetchArticles called!"),$q.all([article.insert(curArticle).then(function(){return curArticle.id=article.getCurrent().id,curRank.article_id=curArticle.id,curRank.article_risk=article.getCurrent().riskElement,rank.insert(curRank)},function(err){console.log(err)})]).then(function(responses){console.log(responses[0].data.data)})}function exampleQuery(){var exQuery="PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> PREFIX edu: <http://"+CONFIG.graph_url+"/ontology/educational.owl#> PREFIX rdftype: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> PREFIX dc: <http://purl.org/dc/elements/1.1/> PREFIX users: <https://"+CONFIG.graph_url+"/users/> SELECT ?title ?url ?views (count(?rating) as ?ratings) WHERE { ?s rdf:type edu:object. ?s edu:title ?title. ?s edu:url ?url. ?s edu:views ?views. ?rating rdf:type edu:rating. ?rating edu:for_article ?s. } ";return rdf.query(exQuery).then(function(data){console.log("Example Query : "),console.log(data)})["catch"](function(err){console.log(err)})}var curArticle={},curRank={};return{setArticle:function(article){curArticle=article},article:function(){return curArticle},setRank:function(rank){curRank=rank},rank:function(){return curRank},setRating:function(r){return curArticle.rating=r,rating.insert(curArticle)},rating:function(){return curArticle.rating},editArticle:editArticle,fetchArticles:fetchArticles,exampleQuery:exampleQuery}}]),angular.module("edumaterialApp").factory("medlineplus",["$http",function($http){function search(retstart,query,limit){var url=settings.apiurl+"term="+encodeURIComponent(query)+"&retstart="+(retstart||0)+"&db="+settings.db+"&rettype="+settings.rettype+"&retmax="+(limit||settings.retmax)+"&tool="+settings.tool+"&email="+settings.email;return $http.get(url,{cache:!0})}var settings={apiurl:"/api/medlineplus/query/",db:"healthTopics",rettype:"brief",retmax:10,tool:"carre-project-educational-aggregator",email:"portokallidis@gmail.com"};return{search:search}}]),angular.module("edumaterialApp").service("rank",["rdf","uuid4","CONFIG",function(rdf,uuid4,CONFIG){function processRank(rank){return rdf.find([["?id",rdf.pre.rdftype,rdf.pre.edu+"#rank"],["?id",rdf.pre.edu+"#for_article",rdf.pre.publicUri+rank.article_id],["?id",rdf.pre.edu+"#query",'"'+rank.query+'"^^xsd:string']],["?id"],["LIMIT 1"]).then(function(results){var elem={};return results.data.length>0?(elem=results.data.data[0],rank.id=elem.id.value.split(CONFIG.graph_url+"/"+CONFIG.subgraph_url+"/educational/rank/")[1],modifyRank(rank)):(rank.id=uuid4.generate(),insertRank(rank)),insertRiskElement(rank),rank.id},function(err){return console.log(err),!1})}function modifyRank(rank){console.log("Modify Rank called!");var oldtriples=[],newtriples=[];oldtriples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#date","?date"]),oldtriples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#total","?total"]),oldtriples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#total","?pos"]),newtriples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#date",'"'+rank.date+'"^^xsd:dateTime']),newtriples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#total",'"'+rank.total+'"^^xsd:nonNegativeInteger']),newtriples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#total",'"'+rank.position+'"^^xsd:nonNegativeInteger']),rdf.modify(oldtriples,oldtriples,newtriples).then(function(results){console.log(results)})["catch"](function(error){console.log("Error :"),console.log(error)})}function insertRank(rank){console.log("Insert Rank called!");var triples=[];triples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.rdftype,rdf.pre.edu+"#rank"]),triples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#for_article",rdf.pre.publicUri+rank.article_id]),triples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#query",'"'+rank.query+'"^^xsd:string']),triples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#date",'"'+rank.date+'"^^xsd:dateTime']),triples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#total",'"'+rank.total+'"^^xsd:nonNegativeInteger']),triples.push([rdf.pre.publicUri+"rank/"+rank.id,rdf.pre.edu+"#position",'"'+rank.position+'"^^xsd:nonNegativeInteger']),rdf.insert(triples).then(function(results){console.log(results)})["catch"](function(error){console.log("Error :"),console.log(error)})}function insertRiskElement(rank){console.log("Insert Risk Element called!");var triples=[];rank.article_risk&&triples.push([rank.article_risk,"http://"+CONFIG.graph_url+"/ontology/risk.owl#has_educational_material",rdf.pre.publicUri+rank.article_id]),rdf.insert(triples).then(function(results){console.log(results)})["catch"](function(error){console.log("Error :"),console.log(error)})}return{insert:processRank}}]),angular.module("edumaterialApp").service("rating",["rdf","uuid4","Auth","CONFIG",function(rdf,uuid4,Auth,CONFIG){function processRating(article){var ratingsum=article.rating.reduce(function(total,rating){return total+Number(rating.value)},0);return console.log("Rating Sum is : "+ratingsum),rdf.find([["?id",rdf.pre.rdftype,rdf.pre.edu+"#rating"],["?id",rdf.pre.edu+"#for_article",rdf.pre.publicUri+article.id],["?id",rdf.pre.edu+"#rated_by_user",user.graphName]],["?id"],["LIMIT 1"]).then(function(results){if(0===ratingsum)return!1;var elem=results.data.data[0],rating={};return rating.article_id=article.id,rating.rates=article.rating,rating.date=(new Date).toISOString(),elem&&elem.id?(rating.id=elem.id.value.split(CONFIG.graph_url+"/"+CONFIG.subgraph_url+"/educational/rating/")[1],console.log("Rating ID: ",rating.id),modifyRating(rating)):(console.log("Rating NOT exists: "),rating.id=uuid4.generate(),insertRating(rating))})["catch"](function(err){return console.log(err),!1})}function loadRating(article){return console.log("Load Rating Called for article: "+article.url+" by user "+user.graphName),rdf.find([["?id",rdf.pre.rdftype,rdf.pre.edu+"#rating"],["?article",rdf.pre.edu+"#url",article.url],["?id",rdf.pre.edu+"#for_article","?article"],["?id",rdf.pre.edu+"#rated_by_user",user.graphName],["?id",rdf.pre.edu+"#depth_of_coverage","?depth_of_coverage"],["?id",rdf.pre.edu+"#comprehensiveness","?comprehensiveness"],["?id",rdf.pre.edu+"#relevancy","?relevancy"],["?id",rdf.pre.edu+"#accuracy","?accuracy"],["?id",rdf.pre.edu+"#educational_level","?educational_level"],["?id",rdf.pre.edu+"#validity","?validity"]],["?depth_of_coverage ?comprehensiveness ?relevancy ?accuracy ?educational_level ?validity"])}function modifyRating(rating){console.log("Modify Rating called!"),console.log(rating);var oldtriples=[],newtriples=[];oldtriples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#date","?date"]);for(var i=0,rc=Auth.rating_criteria;i<rc.length;i++)rating.rates[i]||(rating.rates[i]={value:0}),oldtriples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#"+rc[i].name.replace(/\s+/g,"_").toLowerCase(),"?ra"+i]);console.log(oldtriples),newtriples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#date",'"'+rating.date+'"^^xsd:dateTime']);for(var i=0,rc=Auth.rating_criteria;i<rc.length;i++)rating.rates[i]||(rating.rates[i]={value:0}),newtriples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#"+rc[i].name.replace(/\s+/g,"_").toLowerCase(),'"'+rating.rates[i].value+'"^^xsd:nonNegativeInteger']);return console.log(newtriples),rdf.modify(oldtriples,oldtriples,newtriples).then(function(results){console.log(results)})["catch"](function(error){console.log("Error :"),console.log(error)})}function insertRating(rating){console.log("Insert Rating called!");var triples=[];triples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.rdftype,rdf.pre.edu+"#rating"]),triples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#for_article",rdf.pre.publicUri+rating.article_id]),triples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#rated_by_user",user.graphName]),triples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#date",'"'+rating.date+'"^^xsd:dateTime']);for(var i=0,rc=Auth.rating_criteria;i<rc.length;i++)rating.rates[i]||(rating.rates[i]={value:0}),triples.push([rdf.pre.publicUri+"rating/"+rating.id,rdf.pre.edu+"#"+rc[i].name.replace(/\s+/g,"_").toLowerCase(),'"'+rating.rates[i].value+'"^^xsd:nonNegativeInteger']);return rdf.insert(triples).then(function(results){console.log(results)})["catch"](function(error){console.log("Error :"),console.log(error)})}var user={};return Auth.token?Auth.getCurrentUser().$promise?Auth.getCurrentUser().then(function(){user=Auth.getCurrentUser()}):user=Auth.getCurrentUser():user={},user.username||(user.graphName=rdf.pre.users+"guestuser"),{insert:processRating,load:loadRating}}]),angular.module("edumaterialApp").service("rdf",["$http","$q","CONFIG",function($http,$q,CONFIG){function makeTriple(s,p,o,a,b,c){return s&&s.indexOf("http")>=0&&!a&&(s="<"+s+">"),p&&p.indexOf("http")>=0&&!b&&(p="<"+p+">"),o&&o.indexOf("http")>=0&&!c&&(o="<"+o+">"),s+" "+p+" "+o}function parseTriples(arr){return arr.map(function(triple){return makeTriple(triple[0],triple[1],triple[2])}).join(".")}function query(query){return console.debug("---SPARQL QUERY---"),console.debug(query),query.indexOf("undefined")>=0?(console.error("SPARQL query -- Undefined"),console.debug(query),$q.defer().promise):$http.post("/api/resources/query",{sparql:query},{ignoreLoadingBar:!0})}function find(triples,selectArray,options){return selectArray||(selectArray=["*"]),triples||(triples=["?s ?p ?o"]),options||(options=["LIMIT 20"]),query("SELECT "+selectArray.join(" ")+" FROM <http://"+CONFIG.graph_url+"/"+CONFIG.subgraph_url+"> WHERE { "+parseTriples(triples)+"} "+options.join(" "))}function modify(triples,templateToDelete,templateToInsert){return triples||(triples=[]),templateToInsert||(templateToInsert=[]),templateToDelete||(templateToDelete=[]),query("MODIFY <http://"+CONFIG.graph_url+"/"+CONFIG.subgraph_url+"> DELETE { "+parseTriples(templateToDelete)+" } INSERT { "+parseTriples(templateToInsert)+" } WHERE { "+parseTriples(triples)+"} ")}function insert(triples){return!triples||triples.length<1?$q.reject({error:"You have not specified any triples",data:triples}):query("INSERT DATA { GRAPH <http://"+CONFIG.graph_url+"/"+CONFIG.subgraph_url+"> { "+parseTriples(triples)+"}}")}var prefixes={edu:"http://"+CONFIG.graph_url+"/ontology/educational.owl",rdftype:"http://www.w3.org/1999/02/22-rdf-syntax-ns#type",dc:"http://purl.org/dc/elements/1.1/",publicUri:"http://"+CONFIG.graph_url+"/"+CONFIG.subgraph_url+"/educational/",users:"https://"+CONFIG.graph_url+"/users/"};return{query:query,find:find,insert:insert,modify:modify,pre:prefixes}}]),angular.module("edumaterialApp").factory("suggest",["$http","Auth","CONFIG",function($http,Auth,CONFIG){var getSuggestions=function(val){return val.length>2?$http.get("/api/wikipedia/autocomplete/"+encodeURIComponent(val),{cache:!0,ignoreLoadingBar:!0}).then(function(response){return response.data.length>1?response.data:[]}):[]},sparqlRiskElements=function(){return $http.get("/api/resources/elements/risk_element/"+Auth.language,{cache:!0,ignoreLoadingBar:!0}).then(function(response){return response.data.data.length>1?response.data.data:[]})};return{"for":getSuggestions,riskelements:sparqlRiskElements}}]),angular.module("edumaterialApp").service("Translate",["Auth",function(Auth){var TranslationObj={en:{depth_of_coverage:"Depth of Coverage",comprehensiveness:"Comprehensiveness",relevancy:"Relevancy",accuracy:"Accuracy",educational_level:"Educational level",validity:"Validity",total_results:"results",no_results:"No results...",back_button:"Back",rating_button:"Rating",rating_title:"Article Rating",home_page:"Home",login:"Log in",logout:"Log out",pagination_next:"Next",pagination_prev:"Previous"},el:{depth_of_coverage:"Βάθος ανάλυσης περιεχομένου",comprehensiveness:"Κατανόηση",relevancy:"Σχετικότητα",accuracy:"Ακρίβεια",educational_level:"Απαιτούμενο επίπεδο εκπαίδευσης",validity:"Εγκυρότητα",total_results:"αποτελέσματα",no_results:"Κανένα αποτέλεσμα...",back_button:"Πίσω",rating_button:"Αξιολόγηση",rating_title:"Αξιολόγηση περιεχομένου",home_page:"Αρχική",login:"Σύνδεση",logout:"Αποσύνδεση",pagination_next:"Επόμενα",pagination_prev:"Προηγούμενα"},lt:{depth_of_coverage:"Gylis dangos",comprehensiveness:"Išsamumas",relevancy:"Tinkamumas",accuracy:"Tikslumas",educational_level:"Išsilavinimo lygis reikalavimai",validity:"Galiojimas",total_results:"rezultatai",no_results:"Jokių rezultatų...",back_button:"Atgal",rating_button:"Reitingas",rating_title:"Vertinimas straipsnis",home_page:"Titulinis puslapis",login:"Prisijungti",logout:"Atsijungti",pagination_next:"Kitas",pagination_prev:"Ankstesnis"}};return function(str){return Auth.language&&TranslationObj[Auth.language].hasOwnProperty(str)?TranslationObj[Auth.language][str]:str}}]).filter("translate",["Translate",function(Translate){return function(input){return Translate(input)}}]),angular.module("edumaterialApp").factory("Auth",["$location","$rootScope","$http","$cookies","$q","$window","CONFIG",function($location,$rootScope,$http,$cookies,$q,$window,CONFIG){function authenticate(){return $http.get(CONFIG.api_url+"/userProfile?token="+token,{cache:!0}).then(function(res){return res.data.username||logout(),res},function(err){err&&logout()})}function login(user,callback){$window.location.href=CONFIG.auth_url+"login?next="+$location.absUrl()}function logout(){currentUser={},$window.location.href=CONFIG.auth_url+"logout?next="+$location.absUrl()}var currentUser={guest:!0},token=$cookies.get(CONFIG.token_name)||!1;return console.log("CONFIGURATION: ",CONFIG),{authenticate:authenticate,login:login,logout:logout,getCurrentUser:function(){return currentUser},isLoggedIn:function(){return currentUser.hasOwnProperty("username")},isLoggedInAsync:function(cb){token&&!currentUser.username?authenticate().then(function(res){currentUser=res.data,cb(currentUser)}):token&&currentUser.username?cb(currentUser):(currentUser={guest:!0},cb(currentUser))},isAdmin:function(){return"admin"===currentUser.role},isMedicalExpert:function(){return"medical_expert"===currentUser.role},token:token}}]),angular.module("edumaterialApp").factory("Modal",["$rootScope","$modal",function($rootScope,$modal){function openModal(scope,modalClass){var modalScope=$rootScope.$new();return scope=scope||{},modalClass=modalClass||"modal-default",angular.extend(modalScope,scope),$modal.open({templateUrl:"components/modal/modal.html",windowClass:modalClass,scope:modalScope})}return{confirm:{"delete":function(del){return del=del||angular.noop,function(){var deleteModal,args=Array.prototype.slice.call(arguments),name=args.shift();deleteModal=openModal({modal:{dismissable:!0,title:"Confirm Delete",html:"<p>Are you sure you want to delete <strong>"+name+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(e){deleteModal.close(e)}},{classes:"btn-default",text:"Cancel",click:function(e){deleteModal.dismiss(e)}}]}},"modal-danger"),deleteModal.result.then(function(event){del.apply(event,args)})}}}}}]),angular.module("edumaterialApp").controller("NavbarCtrl",["$scope","$location","Auth","$state","$window",function($scope,$location,Auth,$state,$window){$scope.isCollapsed=$window.innerWidth<768,$scope.isLoggedIn=Auth.isLoggedIn,$scope.login=Auth.login,$scope.isAdmin=Auth.isAdmin,$scope.query=Auth.searchQuery,Auth.notifyNavbar=function(){$scope.query=Auth.searchQuery},$scope.logout=function(){$scope.user={},Auth.logout()},$scope.isActive=function(route){return route===$location.path()},Auth.isLoggedInAsync(function(data){console.log("NavbarCtrl Async login",data),data&&($scope.user=Auth.getCurrentUser())})}]),angular.module("edumaterialApp").filter("propsFilter",function(){return function(items,props){var out=[];return angular.isArray(items)?items.forEach(function(item){for(var itemMatches=!1,keys=Object.keys(props),i=0;i<keys.length;i++){var prop=keys[i],text=props[prop].toLowerCase();if(item[prop].toString().toLowerCase().indexOf(text)!==-1){
itemMatches=!0;break}}itemMatches&&out.push(item)}):out=items,out}}),angular.module("edumaterialApp").filter("strip",function(){return function(input){return String(input).replace(/<[^>]+>/gm,"")}}),angular.module("edumaterialApp").run(["$templateCache",function($templateCache){$templateCache.put("app/main/article_view.html",'<!--ARTICLE PREVIEW--><div class="overlay overlay-door" ng-class="{\'open\':showArticle}"><div class="well preview-container"><div class="clearfix row preview-status"><div class=col-sm-6><button type=button ng-click=toggleArticle(-1) class="overlay overlay-close carre-btn"><span class="glyphicon glyphicon-circle-arrow-left"></span></button></div><div class=col-sm-6><button type=button ng-click="isCollapsed=!isCollapsed" ng-class="{\'active\':isCollapsed}" class="overlay overlay-edit carre-btn"><span class="glyphicon glyphicon-edit"></span></button></div></div><div class="clearfix row rating-container" uib-collapse=!isCollapsed><div class="col-xs-12 col-sm-12 col-md-12"><div class="panel panel-default"><div class=panel-heading><h3 class=panel-title>Extra Information</h3></div><div class=panel-body><h4>Coming soon!</h4></div></div></div><div ng-if=isLoggedIn() class="col-xs-12 col-sm-12 col-md-12"><div class="panel panel-default"><div class=panel-heading><h3 class=panel-title>Article Rating</h3></div><div class=panel-body><div class=row><div class=col-sm-4 ng-repeat="rate in rating track by $index">{{rate.name}} :<rating class=rating ng-model=doc.rating[$index].value max=5></rating></div></div></div></div></div></div></div><div style="position:relative; width:auto; height:auto; margin:auto; top:100px" ng-hide=doc.iframe||!showArticle class=spinner><div class=bounce1></div><div class=bounce2></div><div class=bounce3></div></div><div style=height:100% class="embed-responsive embed-responsive-4by3" ng-bind-html=doc.iframe></div></div>'),$templateCache.put("app/main/main.html",'<header class=hero-unit id=banner><!--<div ng-hide="isLoggedIn()" class="container">--><!--  <h2>CARRE Educational Resources</h2>--><!--  <p><a style="color:white" href="/login">Login</a> to enable rating</p>--><!--</div>--><div class=container><p style=height:5px></p><form ng-submit=searchQuery()><div class=row><div class="col-sm-8 col-sm-offset-2"><div class="input-group search-panel row"><div class=input-group-btn><select class=form-control style="min-width:140px;z-index: inherit" ng-model=curSource ng-options="opt as opt.label for opt in docSources" ng-change=onComplete()></select></div><input ng-model=queryTerm style="z-index: inherit" uib-typeahead="term.name for term in riskElements| filter:$viewValue | limitTo:8" class=form-control typeahead-editable=true typeahead-focus-first=false typeahead-on-select="onComplete($item, $model, $label)"> <span class=input-group-btn style="z-index: 0"><button class="btn btn-default" ng-click=searchQuery() type=submit><span class="glyphicon glyphicon-search"></span></button></span></div></div></div><!--<div class="row">--><!--  <div class="col-sm-8 col-sm-offset-2">--><!--    <h4 ng-show="total>0" class="text-left"><strong class="text-danger">{{total}}</strong> results</h4>--><!--    <div class="text-right"></div>--><!--  </div>--><!--</div>--></form></div></header><!--Wikipedia typeahead--><!--<input style="z-index: inherit;" type="text" ng-model="queryTerm" placeholder="Type terms" typeahead="term for term in getSuggestions($viewValue)" typeahead-loading="loading" class="form-control" typeahead-on-select="onComplete($label)">--><div class=results><div class="col-md-10 col-md-offset-1 col-sm-12"><div class=row><!--top pagination--><div class="col-sm-8 pull-right"><uib-pagination ng-show="total>itemsPerPage" items-per-page=itemsPerPage previous-text="{{\'pagination_prev\'|translate}}" next-text="{{\'pagination_next\'|translate}}" style="z-index: inherit; float:right; margin:auto" total-items=total ng-model=currentPage ng-change=searchQuery(true) max-size=3 rotate=false></uib-pagination></div><div class="col-sm-4 pull-left"><!--total results--><h3 ng-show="total>0"><strong class=text-danger>{{total}}</strong> {{\'total_results\'|translate}}</h3></div></div><div class=row><div class=col-xs-12><!-- Suggestions --><!--<div ng-show="suggestion">--><!--    <h4>Did you mean <a href="" ng-click="suggest(suggestion)">{{suggestion}}</a>?</h4>--><!--    <hr>--><!--</div>--><!-- no results --><div class="alert alert-warning" ng-hide="total>0||results.length>0">{{\'no_results\'|translate}}</div><div class=list-group><a href="" ng-click=toggleArticle($index) class=list-group-item ng-repeat="doc in results track by $index"><h4 class=list-group-item-heading>{{doc.title|strip}} <span class="label label-info">{{doc.avgRating|number:1 }}</span></h4><p class=list-group-item-text ng-bind-html=doc.snippet></p></a></div></div></div></div></div><!--ARTICLE PREVIEW--><div class="overlay overlay-door" ng-class="{\'open\':showArticle}"><div ng-show=showArticle class=preview-container><div class="clearfix row preview-status"><div class=col-sm-6><button type=button ng-click=toggleArticle(-1) class="overlay overlay-close carre-btn"><span class="glyphicon glyphicon-circle-arrow-left"></span> <span>{{\'back_button\'|translate}}</span></button></div><div class=col-sm-6><button ng-show="isLoggedIn()&&user.username.indexOf(\'demo\')===-1" type=button ng-click="isCollapsed=!isCollapsed" ng-class="{\'active\':isCollapsed}" class="overlay overlay-edit carre-btn"><span>{{\'rating_button\'|translate}}</span> <span class="glyphicon glyphicon-edit"></span></button></div></div><div class="clearfix row rating-container" uib-collapse=!isCollapsed><div class="col-xs-12 col-sm-12 col-md-12"><!--<div class="panel panel-default">--><!--  <div class="panel-heading">--><!--    <h3 class="panel-title">Extra Information</h3>--><!--  </div>--><!--  <div class="panel-body">--><!--    <h4>Coming soon!</h4>--><!--  </div>--><!--</div>--></div><div class="col-xs-12 col-sm-12 col-md-12"><div class="panel panel-default"><div class=panel-heading><h3 class=panel-title>{{\'rating_title\'|translate}}</h3></div><div class=panel-body><div class=row><div class=col-sm-4 ng-repeat="rate in rating track by $index">{{rate.rdftype|translate}} :<uib-rating class=rating ng-model=doc.rating[$index].value max=5></uib-rating></div></div></div></div></div></div></div><div style="position:relative; width:auto; height:auto; margin:auto; top:100px" ng-hide=doc.iframe||!showArticle class=spinner><div class=bounce1></div><div class=bounce2></div><div class=bounce3></div></div><div style=height:100%;left:7px class="embed-responsive embed-responsive-4by3" ng-bind-html=doc.iframe></div></div>'),$templateCache.put("components/footer/footer.html",'<footer class=footer><div class=container><div style="float:left;margin:0px 10px"><img src=CARRE-FooterLogo.png width=36 height=40 alt=CARRE> <a href="http://cordis.europa.eu/" target=_blank><img alt=Picture1 src=Picture1-150x150.png width=30 height=30></a></div><div style="float:left;margin:0px 10px">CARRE project is partly funded by the EC under the grant no. FP7-ICT-611140</div></div></footer>'),$templateCache.put("components/modal/modal.html",'<div class=modal-header><button ng-if=modal.dismissable type=button ng-click=$dismiss() class=close>&times;</button><h4 ng-if=modal.title ng-bind=modal.title class=modal-title></h4></div><div class=modal-body><p ng-if=modal.text ng-bind=modal.text></p><div ng-if=modal.html ng-bind-html=modal.html></div></div><div class=modal-footer><button ng-repeat="button in modal.buttons" ng-class=button.classes ng-click=button.click($event) ng-bind=button.text class=btn></button></div>'),$templateCache.put("components/navbar/navbar.html",'<div class="navbar navbar-default navbar-static-top" ng-controller=NavbarCtrl><!--typical navbar--><div class=container><div class=navbar-header><button class=navbar-toggle type=button ng-click="isCollapsed = !isCollapsed"><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href=# class=navbar-brand style=margin-top:-9px><img src=CARRE-FooterLogo.png width=36 height=40 alt=CARRE></a> <span class=brand style="font-size:larger;position:relative; top:13px" href=#>Educational Aggregator</span></div><div uib-collapse=isCollapsed class="navbar-collapse collapse"><ul class="nav navbar-nav"><li ng-show=isAdmin() ng-class="{active: isActive(\'/admin\')}"><a href=/admin>Admin</a></li></ul><ul class="nav navbar-nav navbar-right"><!--User functions--><li ng-show=user.username class=dropdown uib-dropdown><a href id=avatar class=nav-profile uib-dropdown-toggle><span>{{ user.username }}</span> <img gravatar-src=user.email class=img-circle></a><ul class=dropdown-menu uib-dropdown-menu><li><a href="" ng-click=logout()><i class="glyphicon glyphicon-log-out"></i> <span>{{\'logout\'|translate}}</span></a></li></ul></li><li ng-hide=user.username ng-class="{active: isActive(\'/login\')}"><a href ng-click=login()>{{\'login\'|translate}}</a></li></ul></div></div></div>')}]);